# 09. Git工作流实践02

## 9.1 Git Flow 工作流

### 9.1.1 Git Flow 简介

Git Flow 是由 Vincent Driessen 提出的一套完整的分支管理策略，特别适合有明确发布周期的项目。

### 9.1.2 分支类型

Git Flow 定义了五种类型的分支：

**1. 主要分支（长期存在）**

- **main**（或 master）：生产环境代码
  - 永远处于可发布状态
  - 只接受来自 hotfix 和 release 的合并
  - 每次合并都打上版本标签

- **develop**：开发分支
  - 包含最新的开发代码
  - 功能分支从这里创建
  - 功能开发完成后合并回这里

**2. 辅助分支（临时存在）**

- **feature/**：功能分支
  - 从 develop 分支创建
  - 开发完成后合并回 develop
  - 命名：`feature/功能名`

- **release/**：发布分支
  - 从 develop 分支创建
  - 准备新版本发布
  - 合并到 main 和 develop
  - 命名：`release/版本号`

- **hotfix/**：热修复分支
  - 从 main 分支创建
  - 修复生产环境紧急 bug
  - 合并到 main 和 develop
  - 命名：`hotfix/修复内容`

### 9.1.3 分支结构图

```
main:     A---------E---------J (v1.0) (v1.1)
           \       / \       /
release:    \     D   \     I (release/1.1)
             \   /     \   /
develop:      B-C-------F-G-H
               \       /
feature:        K-----L  (feature/new-feature)
```

### 9.1.4 功能开发流程

```bash
# 1. 从 develop 创建功能分支
git checkout develop
git pull origin develop
git checkout -b feature/user-dashboard

# 2. 开发功能
git add .
git commit -m "feat: 添加用户仪表盘"

# 3. 定期从 develop 更新
git checkout develop
git pull origin develop
git checkout feature/user-dashboard
git merge develop

# 4. 功能完成，合并回 develop
git checkout develop
git pull origin develop
git merge --no-ff feature/user-dashboard
git push origin develop

# 5. 删除功能分支
git branch -d feature/user-dashboard
```

### 9.1.5 发布流程

```bash
# 1. 从 develop 创建 release 分支
git checkout develop
git pull origin develop
git checkout -b release/1.2.0

# 2. 准备发布（修复小 bug，更新版本号等）
git add .
git commit -m "chore: 准备 1.2.0 版本发布"

# 3. 合并到 main 并打标签
git checkout main
git pull origin main
git merge --no-ff release/1.2.0
git tag -a v1.2.0 -m "Release version 1.2.0"
git push origin main --tags

# 4. 合并回 develop
git checkout develop
git pull origin develop
git merge --no-ff release/1.2.0
git push origin develop

# 5. 删除 release 分支
git branch -d release/1.2.0
```

### 9.1.6 热修复流程

```bash
# 1. 从 main 创建 hotfix 分支
git checkout main
git pull origin main
git checkout -b hotfix/critical-security-fix

# 2. 修复 bug
git add .
git commit -m "fix: 修复严重安全漏洞"

# 3. 合并到 main 并打标签
git checkout main
git merge --no-ff hotfix/critical-security-fix
git tag -a v1.2.1 -m "Hotfix version 1.2.1"
git push origin main --tags

# 4. 合并到 develop
git checkout develop
git merge --no-ff hotfix/critical-security-fix
git push origin develop

# 5. 删除 hotfix 分支
git branch -d hotfix/critical-security-fix
```

### 9.1.7 使用 git-flow 工具

安装 git-flow：

```bash
# macOS
brew install git-flow

# Linux (Ubuntu/Debian)
apt-get install git-flow

# Windows (Git Bash)
# 通常已包含在 Git for Windows 中
```

初始化 git-flow：

```bash
git flow init

# 会提示配置分支名称，使用默认值即可
```

使用 git-flow 命令：

```bash
# 开始新功能
git flow feature start user-dashboard
# 等同于: git checkout -b feature/user-dashboard develop

# 完成功能
git flow feature finish user-dashboard
# 等同于: 
# git checkout develop
# git merge --no-ff feature/user-dashboard
# git branch -d feature/user-dashboard

# 开始发布
git flow release start 1.2.0

# 完成发布
git flow release finish 1.2.0

# 开始热修复
git flow hotfix start critical-fix

# 完成热修复
git flow hotfix finish critical-fix
```

### 9.1.8 Git Flow 的优缺点

**优点**：
- ✅ 清晰的分支结构
- ✅ 适合计划性发布
- ✅ 支持多版本并行开发
- ✅ 明确的发布流程
- ✅ 适合大型项目

**缺点**：
- ❌ 相对复杂
- ❌ 需要维护多个长期分支
- ❌ 不适合持续部署
- ❌ 合并操作较多

**适用场景**：
- 桌面应用程序
- 移动应用
- 有明确版本发布周期的项目
- 需要支持多个版本的项目

## 9.2 GitLab Flow 工作流

### 9.2.1 GitLab Flow 简介

GitLab Flow 是 GitLab 提出的工作流，结合了 GitHub Flow 的简单和 Git Flow 的版本管理能力。

### 9.2.2 环境分支策略

```
main (开发环境)
  ↓
pre-production (预发布环境)
  ↓
production (生产环境)
```

### 9.2.3 工作流程

**功能开发**：

```bash
# 1. 从 main 创建功能分支
git checkout main
git pull origin main
git checkout -b feature/new-feature

# 2. 开发并推送
git add .
git commit -m "feat: 添加新功能"
git push origin feature/new-feature

# 3. 创建 Merge Request 到 main
# 在 GitLab 上创建 MR

# 4. 代码审查通过后合并到 main
# main 自动部署到开发环境

# 5. 从 main 创建 MR 到 pre-production
# 在 GitLab 上创建 MR: main → pre-production

# 6. 测试通过后合并到 pre-production
# pre-production 自动部署到预发布环境

# 7. 从 pre-production 创建 MR 到 production
# 在 GitLab 上创建 MR: pre-production → production

# 8. 最终审批后合并到 production
# production 自动部署到生产环境
```

**热修复**：

```bash
# 1. 从 production 创建 hotfix 分支
git checkout production
git pull origin production
git checkout -b hotfix/urgent-fix

# 2. 修复并推送
git add .
git commit -m "fix: 修复紧急问题"
git push origin hotfix/urgent-fix

# 3. 创建 MR 到 production
# 审查后直接合并到 production

# 4. Cherry-pick 到其他环境
git checkout pre-production
git cherry-pick <commit-hash>
git push origin pre-production

git checkout main
git cherry-pick <commit-hash>
git push origin main
```

### 9.2.4 版本分支策略

适用于需要支持多个版本的项目：

```
main (v2.0 开发)
  ↓
stable-1.x (v1.x 维护)
  ↓
stable-1.0 (v1.0 维护)
```

```bash
# 在稳定版本分支上修复 bug
git checkout stable-1.x
git checkout -b fix/bug-in-v1
git add .
git commit -m "fix: 修复 v1.x 的 bug"

# 合并到稳定版本分支
git checkout stable-1.x
git merge fix/bug-in-v1
git push origin stable-1.x
git tag v1.2.3
git push origin v1.2.3

# Cherry-pick 到主分支（如果适用）
git checkout main
git cherry-pick <commit-hash>
git push origin main
```

### 9.2.5 GitLab Flow 的优点

- ✅ 简单直观
- ✅ 与 CI/CD 紧密集成
- ✅ 支持多环境部署
- ✅ 灵活适应不同场景
- ✅ 明确的部署路径

### 9.2.6 适用场景

- Web 应用
- 微服务架构
- 有多个部署环境的项目
- 需要支持多版本的项目

## 9.3 Forking 工作流

### 9.3.1 Forking 工作流简介

Forking 工作流是开源项目常用的协作方式，每个开发者都有自己的服务端仓库。

### 9.3.2 工作流程图

```
原始仓库（upstream）
        ↓ fork
开发者A的仓库（origin-A）
        ↓ clone
开发者A的本地仓库

开发者B的仓库（origin-B）
        ↓ clone
开发者B的本地仓库
```

### 9.3.3 贡献者工作流程

**初始设置**：

```bash
# 1. Fork 原始仓库（在 GitHub 上操作）

# 2. 克隆你的 fork
git clone git@github.com:your-username/project.git
cd project

# 3. 添加上游仓库
git remote add upstream git@github.com:original-owner/project.git

# 4. 查看远程仓库
git remote -v
# origin    git@github.com:your-username/project.git
# upstream  git@github.com:original-owner/project.git
```

**开发流程**：

```bash
# 1. 同步上游仓库
git fetch upstream
git checkout main
git merge upstream/main
git push origin main

# 2. 创建功能分支
git checkout -b feature/awesome-feature

# 3. 开发并提交
git add .
git commit -m "feat: 添加很棒的功能"

# 4. 推送到你的 fork
git push origin feature/awesome-feature

# 5. 创建 Pull Request
# 在 GitHub 上从你的 fork 向原始仓库创建 PR

# 6. 根据反馈修改
git add .
git commit -m "fix: 根据反馈修改"
git push origin feature/awesome-feature

# 7. PR 合并后同步并清理
git checkout main
git fetch upstream
git merge upstream/main
git push origin main
git branch -d feature/awesome-feature
git push origin --delete feature/awesome-feature
```

### 9.3.4 维护者工作流程

```bash
# 1. 审查 Pull Request
# 在 GitHub 上查看 PR 的代码变更

# 2. 本地测试 PR（可选）
git fetch origin pull/123/head:pr-123
git checkout pr-123
# ... 测试 ...

# 3. 在 GitHub 上合并 PR
# 点击 "Merge pull request"

# 4. 删除分支（可选）
# GitHub 通常会提示是否删除分支
```

### 9.3.5 处理冲突

```bash
# 如果 PR 有冲突

# 1. 在你的本地仓库同步上游
git fetch upstream
git checkout feature/awesome-feature
git merge upstream/main

# 2. 解决冲突
# ... 编辑冲突文件 ...
git add .
git commit -m "merge: 解决与上游的冲突"

# 3. 推送更新
git push origin feature/awesome-feature

# PR 会自动更新
```

### 9.3.6 Forking 工作流的优点

- ✅ 安全：贡献者无法直接推送到原始仓库
- ✅ 灵活：每个开发者有完全的控制权
- ✅ 适合开源：陌生人也可以贡献代码
- ✅ 代码审查：维护者可以审查所有贡献

### 9.3.7 适用场景

- 开源项目
- 大型团队
- 需要严格权限控制的项目
- 外部贡献者较多的项目

## 9.4 选择合适的工作流

### 9.4.1 决策树

```
是小团队（<5人）且项目简单？
  是 → 集中式工作流
  否 ↓

需要持续部署？
  是 → GitHub Flow
  否 ↓

有明确的发布周期？
  是 → Git Flow
  否 ↓

有多个部署环境？
  是 → GitLab Flow
  否 ↓

是开源项目？
  是 → Forking 工作流
  否 → 功能分支工作流
```

### 9.4.2 工作流对比

| 工作流 | 复杂度 | 分支数量 | 适合规模 | 发布方式 |
|--------|--------|----------|----------|----------|
| 集中式 | ⭐ | 1 | 1-3人 | 随时 |
| 功能分支 | ⭐⭐ | 多个 | 5-20人 | 灵活 |
| GitHub Flow | ⭐⭐ | 多个 | 5-50人 | 持续部署 |
| Git Flow | ⭐⭐⭐⭐ | 很多 | 10-100人 | 计划发布 |
| GitLab Flow | ⭐⭐⭐ | 多个 | 10-100人 | 环境部署 |
| Forking | ⭐⭐⭐ | 多个 | 任意 | 灵活 |

### 9.4.3 混合使用

实际项目中，可以根据需要混合使用不同的工作流：

**示例1：GitHub Flow + 环境分支**

```
main (开发环境) → 持续部署
  ↓
production (生产环境) → 手动部署
```

**示例2：Git Flow + Forking**

开源项目使用 Forking 接受外部贡献，内部使用 Git Flow 管理版本。

## 9.5 工作流最佳实践

### 9.5.1 提交规范

**提交信息格式**：

```
<type>(<scope>): <subject>

<body>

<footer>
```

**类型（type）**：
- `feat`：新功能
- `fix`：bug 修复
- `docs`：文档
- `style`：格式
- `refactor`：重构
- `perf`：性能优化
- `test`：测试
- `chore`：构建/工具

**示例**：

```bash
git commit -m "feat(auth): 添加 OAuth2 认证支持

- 实现 Google OAuth2 登录
- 添加用户信息同步
- 更新文档

Closes #123"
```

### 9.5.2 分支保护

在 GitHub/GitLab 上设置分支保护规则：

- ✅ 要求 PR 审查
- ✅ 要求 CI 通过
- ✅ 禁止强制推送
- ✅ 要求分支是最新的

### 9.5.3 代码审查清单

**功能性**：
- [ ] 实现了需求
- [ ] 没有引入 bug
- [ ] 边界情况处理

**代码质量**：
- [ ] 代码清晰易懂
- [ ] 遵循编码规范
- [ ] 没有重复代码

**测试**：
- [ ] 有足够的测试
- [ ] 测试有意义
- [ ] 测试通过

**文档**：
- [ ] 代码有必要的注释
- [ ] 更新了相关文档
- [ ] API 文档完整

**性能和安全**：
- [ ] 没有性能问题
- [ ] 没有安全漏洞
- [ ] 资源正确释放

### 9.5.4 CI/CD 集成

**持续集成**：

```yaml
# .github/workflows/ci.yml
name: CI

on:
  pull_request:
    branches: [ main, develop ]
  push:
    branches: [ main, develop ]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Setup Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '16'
      - name: Install dependencies
        run: npm install
      - name: Run tests
        run: npm test
      - name: Run linter
        run: npm run lint
```

**持续部署**：

```yaml
# .github/workflows/cd.yml
name: CD

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Deploy to production
        run: |
          # 部署脚本
```

## 9.6 总结

- **Git Flow**：完整的分支管理策略，适合有发布周期的项目
- **GitLab Flow**：结合环境部署，适合多环境项目
- **Forking 工作流**：适合开源项目和大型团队
- **选择工作流**：根据团队规模、项目类型和发布方式选择
- **最佳实践**：规范提交、保护分支、代码审查、CI/CD集成

---

**上一章节**：[08. Git工作流实践01](./08-git工作流实践01.md)

**下一章节**：[10. Git工作流实践演示](./10-git工作流实践演示.md)
