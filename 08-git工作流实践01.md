# 08. Git工作流实践01

## 8.1 什么是 Git 工作流

### 8.1.1 工作流的定义

Git 工作流（Git Workflow）是团队协作时采用的一套规范和流程，定义了：
- 如何创建和管理分支
- 如何进行代码审查
- 如何合并代码
- 如何发布版本

### 8.1.2 为什么需要工作流

- **规范开发流程**：统一的工作方式提高效率
- **减少冲突**：合理的分支策略减少代码冲突
- **保证质量**：通过代码审查保证代码质量
- **便于回滚**：清晰的版本管理便于问题追溯
- **支持并行开发**：多个功能可以同时开发

### 8.1.3 常见的 Git 工作流

1. **集中式工作流**（Centralized Workflow）
2. **功能分支工作流**（Feature Branch Workflow）
3. **Git Flow 工作流**（Git Flow Workflow）
4. **GitHub Flow 工作流**（GitHub Flow Workflow）
5. **GitLab Flow 工作流**（GitLab Flow Workflow）
6. **Forking 工作流**（Forking Workflow）

## 8.2 集中式工作流

### 8.2.1 工作流程

集中式工作流类似于 SVN，所有开发者都在 `main` 分支上工作。

```
main: A---B---C---D---E---F
       ↑   ↑   ↑   ↑   ↑   ↑
     开发者A B  A  B  A  B
```

### 8.2.2 使用步骤

```bash
# 1. 克隆仓库
git clone <repository-url>
cd <repository>

# 2. 拉取最新代码
git pull origin main

# 3. 修改代码
# ... 编辑文件 ...

# 4. 提交到本地
git add .
git commit -m "feat: 添加新功能"

# 5. 拉取最新代码（可能有冲突）
git pull origin main

# 6. 推送到远程
git push origin main
```

### 8.2.3 优点

- **简单直接**：容易理解和上手
- **适合小团队**：人数少，冲突少
- **无需学习分支**：降低学习成本

### 8.2.4 缺点

- **容易冲突**：所有人都在一个分支上工作
- **不利于并行开发**：无法同时开发多个功能
- **难以回滚**：所有提交都在 main 分支
- **无代码审查**：直接推送到主分支

### 8.2.5 适用场景

- 个人项目
- 非常小的团队（2-3人）
- 简单的项目
- 从 SVN 迁移过来的团队

## 8.3 功能分支工作流

### 8.3.1 工作流程

每个新功能都在独立的分支上开发，完成后合并到 `main` 分支。

```
main:     A---B-------F-------G
               \     /       /
feature-1:      C---D       /
                     \     /
feature-2:            E---/
```

### 8.3.2 使用步骤

```bash
# 1. 克隆仓库
git clone <repository-url>
cd <repository>

# 2. 从 main 创建功能分支
git checkout main
git pull origin main
git checkout -b feature/user-authentication

# 3. 开发功能
git add .
git commit -m "feat: 实现用户认证"

# 4. 推送功能分支
git push -u origin feature/user-authentication

# 5. 创建 Pull Request（在 GitHub/GitLab 上）

# 6. 代码审查通过后合并到 main

# 7. 删除功能分支
git checkout main
git pull origin main
git branch -d feature/user-authentication
git push origin --delete feature/user-authentication
```

### 8.3.3 分支命名规范

```
# 功能开发
feature/user-login
feature/shopping-cart
feature/payment-integration

# Bug 修复
fix/login-error
fix/payment-bug

# 文档更新
docs/update-readme
docs/api-documentation

# 代码重构
refactor/optimize-database
refactor/clean-code

# 性能优化
perf/improve-loading
perf/optimize-query

# 测试
test/add-unit-tests
test/integration-tests
```

### 8.3.4 Pull Request 流程

**创建 PR**：
1. 推送功能分支到远程
2. 在 GitHub/GitLab 上创建 Pull Request
3. 填写 PR 描述：做了什么、为什么、如何测试

**代码审查**：
1. 团队成员审查代码
2. 提出改进建议
3. 讨论和修改

**合并 PR**：
1. 所有审查通过
2. CI/CD 测试通过
3. 合并到 main 分支
4. 删除功能分支

### 8.3.5 优点

- **功能隔离**：每个功能独立开发
- **支持代码审查**：通过 PR 进行审查
- **减少冲突**：不同功能在不同分支
- **便于回滚**：可以单独回滚某个功能

### 8.3.6 缺点

- **分支管理复杂**：需要管理多个分支
- **合并冲突**：长时间不合并会有冲突
- **没有发布流程**：缺少明确的发布规范

### 8.3.7 适用场景

- 中小型团队
- 敏捷开发
- 持续交付的项目
- 需要代码审查的项目

## 8.4 GitHub Flow 工作流

### 8.4.1 核心原则

GitHub Flow 是一种简化的工作流，基于以下原则：
- `main` 分支永远是可部署的
- 从 `main` 创建描述性的分支进行开发
- 经常推送到远程同名分支
- 通过 Pull Request 合并代码
- 合并后立即部署

### 8.4.2 工作流程图

```
main: A---B-------E-------H (永远可部署)
           \     /       /
feature:    C---D       /
                 \     /
hotfix:           F---G
```

### 8.4.3 详细步骤

**步骤1：创建分支**

```bash
# 从 main 创建分支
git checkout main
git pull origin main
git checkout -b feature/add-user-avatar
```

**步骤2：开发和提交**

```bash
# 添加提交
git add .
git commit -m "feat: 添加用户头像上传功能"

# 继续开发
git add .
git commit -m "feat: 添加头像预览功能"

# 经常推送到远程
git push origin feature/add-user-avatar
```

**步骤3：创建 Pull Request**

在 GitHub 上：
1. 点击 "New Pull Request"
2. 选择 base: `main` 和 compare: `feature/add-user-avatar`
3. 填写 PR 标题和描述
4. 指定审查者
5. 创建 PR

**步骤4：讨论和审查**

- 团队成员审查代码
- 在 PR 中讨论
- 根据反馈修改代码
- 推送新的提交

```bash
# 根据反馈修改
git add .
git commit -m "fix: 根据审查意见修改头像大小限制"
git push origin feature/add-user-avatar
```

**步骤5：合并和部署**

```bash
# 审查通过后，在 GitHub 上合并 PR

# 本地更新
git checkout main
git pull origin main

# 删除本地分支
git branch -d feature/add-user-avatar

# 删除远程分支（如果没有自动删除）
git push origin --delete feature/add-user-avatar
```

**步骤6：部署**

```bash
# 合并到 main 后立即部署到生产环境
# 通常通过 CI/CD 自动完成
```

### 8.4.4 关键规则

1. **main 分支永远可部署**
   - 所有合并到 main 的代码都必须经过测试
   - main 分支应该始终处于可发布状态

2. **描述性的分支名**
   - 使用清晰的分支名描述正在做什么
   - 例如：`feature/add-user-authentication`

3. **频繁推送**
   - 至少每天推送一次
   - 让团队知道你在做什么
   - 作为备份

4. **使用 Pull Request**
   - 所有代码必须通过 PR 合并
   - PR 提供了讨论和审查的平台
   - 记录了为什么做这个改动

5. **合并后立即部署**
   - 快速反馈
   - 问题尽早发现

### 8.4.5 处理冲突

```bash
# 在 PR 合并前，可能需要更新分支
git checkout feature/add-user-avatar
git fetch origin
git merge origin/main

# 或使用 rebase（保持历史线性）
git rebase origin/main

# 解决冲突后推送
git push origin feature/add-user-avatar
```

### 8.4.6 优点

- **简单**：只有一个主分支，容易理解
- **快速反馈**：频繁部署，快速发现问题
- **代码审查**：所有代码都经过审查
- **持续交付**：支持持续部署

### 8.4.7 缺点

- **需要成熟的 CI/CD**：依赖自动化测试和部署
- **不适合定期发布**：没有明确的版本概念
- **需要高测试覆盖率**：确保 main 分支稳定

### 8.4.8 适用场景

- Web 应用
- SaaS 产品
- 持续部署的项目
- 小到中型团队

## 8.5 Pull Request 最佳实践

### 8.5.1 创建高质量的 PR

**PR 标题**：
```
feat: 添加用户认证功能
fix: 修复登录页面的空指针异常
docs: 更新 API 文档
refactor: 重构数据库查询逻辑
```

**PR 描述模板**：
```markdown
## 描述
简要描述这个 PR 做了什么。

## 变更类型
- [ ] Bug 修复
- [x] 新功能
- [ ] 代码重构
- [ ] 文档更新

## 相关 Issue
Closes #123

## 测试
- 添加了单元测试
- 手动测试通过
- 截图（如果有 UI 变化）

## 检查清单
- [x] 代码遵循项目规范
- [x] 添加了必要的测试
- [x] 更新了相关文档
- [x] 本地测试通过
```

### 8.5.2 审查 PR 的要点

**代码质量**：
- 代码是否清晰易懂
- 是否遵循编码规范
- 是否有重复代码

**功能性**：
- 是否实现了预期功能
- 是否有边界情况处理
- 错误处理是否完善

**测试**：
- 是否有足够的测试覆盖
- 测试是否有意义
- 是否考虑了异常情况

**性能**：
- 是否有性能问题
- 数据库查询是否优化
- 是否有不必要的计算

**安全**：
- 是否有安全漏洞
- 输入是否经过验证
- 敏感信息是否暴露

### 8.5.3 PR 审查流程

```bash
# 1. 检出 PR 分支
git fetch origin
git checkout -b pr-123 origin/feature/add-user-avatar

# 2. 查看代码变更
git log main..pr-123
git diff main...pr-123

# 3. 本地运行和测试
npm install
npm test
npm start

# 4. 在 GitHub 上添加审查意见

# 5. 如果有修改建议，作者修改后重新审查
```

### 8.5.4 PR 大小建议

- **小而专注**：一个 PR 只做一件事
- **控制行数**：建议不超过 400 行代码变更
- **及时提交**：不要等所有功能完成才创建 PR
- **使用 Draft PR**：开发中可以创建草稿 PR

## 8.6 实战案例

### 8.6.1 案例：开发新功能

```bash
# 场景：开发用户资料编辑功能

# 1. 创建功能分支
git checkout main
git pull origin main
git checkout -b feature/user-profile-edit

# 2. 开发功能（第一部分）
# ... 创建 UI 界面 ...
git add src/components/ProfileEdit.vue
git commit -m "feat: 添加用户资料编辑界面"
git push origin feature/user-profile-edit

# 3. 继续开发（第二部分）
# ... 实现保存逻辑 ...
git add src/api/user.js
git commit -m "feat: 实现用户资料保存 API"
git push origin feature/user-profile-edit

# 4. 添加测试
# ... 编写测试 ...
git add tests/user-profile.test.js
git commit -m "test: 添加用户资料编辑测试"
git push origin feature/user-profile-edit

# 5. 创建 Pull Request
# 在 GitHub 上创建 PR，填写描述

# 6. 根据审查意见修改
# ... 修改代码 ...
git add .
git commit -m "fix: 根据审查意见优化表单验证"
git push origin feature/user-profile-edit

# 7. PR 合并后清理
git checkout main
git pull origin main
git branch -d feature/user-profile-edit
```

### 8.6.2 案例：修复生产环境 Bug

```bash
# 场景：生产环境登录失败

# 1. 从 main 创建 hotfix 分支
git checkout main
git pull origin main
git checkout -b hotfix/login-token-issue

# 2. 定位和修复 bug
# ... 修复代码 ...
git add src/auth/token.js
git commit -m "fix: 修复 token 过期判断逻辑"

# 3. 添加测试防止回归
# ... 添加测试 ...
git add tests/auth/token.test.js
git commit -m "test: 添加 token 过期测试用例"

# 4. 推送并创建 PR
git push -u origin hotfix/login-token-issue
# 创建 PR，标记为 "urgent"

# 5. 快速审查和合并
# 团队快速审查

# 6. 合并后立即部署
# CI/CD 自动部署到生产环境

# 7. 清理
git checkout main
git pull origin main
git branch -d hotfix/login-token-issue
```

### 8.6.3 案例：多人协作功能

```bash
# 场景：团队开发电商系统的购物车功能

# 开发者A：负责前端
git checkout -b feature/shopping-cart-ui
# ... 开发 UI ...
git push origin feature/shopping-cart-ui

# 开发者B：负责后端 API
git checkout -b feature/shopping-cart-api
# ... 开发 API ...
git push origin feature/shopping-cart-api

# 开发者C：负责数据库
git checkout -b feature/shopping-cart-db
# ... 设计数据库 ...
git push origin feature/shopping-cart-db

# 集成：创建集成分支
git checkout main
git pull origin main
git checkout -b feature/shopping-cart-integration

# 合并各个子分支
git merge feature/shopping-cart-db
git merge feature/shopping-cart-api
git merge feature/shopping-cart-ui

# 集成测试
# ... 测试整个功能 ...
git push origin feature/shopping-cart-integration

# 创建 PR 并合并
```

## 8.7 总结

- **集中式工作流**：适合小团队，简单直接
- **功能分支工作流**：每个功能独立分支，支持代码审查
- **GitHub Flow**：简单高效，适合持续部署
- **Pull Request**：代码审查的核心工具
- **分支命名**：使用描述性的分支名
- **小而专注**：PR 应该小而专注，易于审查

---

**上一章节**：[07. Git远程分支管理](./07-git远程分支管理.md)

**下一章节**：[09. Git工作流实践02](./09-git工作流实践02.md)
